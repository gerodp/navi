<link rel="stylesheet" type="text/css" href="style.css" />
<script type="text/javascript" src="scripts.js"></script>
 <script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script>

var statChart		   = null;
var surfSessionStorage = null;

var MAX_DOMAINS_DISPLAYED = 5;

function StatisticsGraph()
{
}

StatisticsGraph.prototype.setSessions = function(sessions)
{
	if( sessions == null || sessions.length == 0 )
	{
		document.write("No data found.");
	}
	else
	{		
		var totalTime = 0;
		
		var sessionsByTime = new Array();
		
		for(var i = 0; i < sessions.length; i++)
		{	
			totalTime += sessions[i].getDuration();
			
			var insertIndex = sessionsByTime.length;
			
			while(insertIndex > 0 && sessionsByTime[insertIndex-1].getDuration() < sessions[i].getDuration() )
			{
				insertIndex--;
			}
			
			sessionsByTime.splice(insertIndex, 0, sessions[i]);
		}
		
		var data = new google.visualization.DataTable();
		
		data.addColumn('string', 'Domain');
        data.addColumn('number', 'HH:MM:SS');
		
		var tableHtml = "<table align='center'><tbody><tr><th>Domain</th><th>Time</th></tr>";
		
		for(var i = 0; i < Math.min(sessionsByTime.length, MAX_DOMAINS_DISPLAYED); i++)
		{
			data.addRow([sessionsByTime[i].getDomain(), sessionsByTime[i].getDuration()/totalTime]);
			
			var icoElement = "<img src='http://" + sessionsByTime[i].getDomain() + "/favicon.ico'/>";
			
			tableHtml += "<tr>" +"<td>"+ icoElement + " "+ sessionsByTime[i].getDomain() +"</td>" + "<td>" + timeToStr(sessionsByTime[i].getDuration(),false)+ "</td>" + "</tr>";
		}
		
		var othersTime = 0;
		
		for(var i = MAX_DOMAINS_DISPLAYED; i < sessionsByTime.length; i++)
		{
			othersTime += sessionsByTime[i].getDuration();
		}
		
		if( sessionsByTime.length > MAX_DOMAINS_DISPLAYED )
		{
			data.addRow(["Others", othersTime/totalTime]);
		
			tableHtml += "<tr>" +"<td>Others</td>" + "<td>" + timeToStr(othersTime,false)+ "</td>" + "</tr>";
		}
		
		tableHtml += "</tbody></table>";
		
		  // Instantiate and draw our chart, passing in some options.
        var chart = new google.visualization.PieChart(document.getElementById('pieDiv'));	
        chart.draw(data, {width: 500, height: 300, is3D: true});
		
		document.getElementById("navTime").innerText = timeToStr( totalTime,true );
		
		document.getElementById("tableDiv").innerHTML = tableHtml;
		
		
	}
}

function showOpenedTabs()
{
	// Load the Visualization API and the piechart package.
    google.load('visualization', '1', {'packages':['corechart']});
      
    // Set a callback to run when the Google Visualization API is loaded.
    google.setOnLoadCallback(drawTodayChart);
	
	surfSessionStorage = new SessionStorage();
	
	statChart = new StatisticsGraph();

	surfSessionStorage.load( DATABASE_NAME );
}

function drawTodayChart()
{
	document.getElementById("navText").innerText = "Today you navigated ";
	
	surfSessionStorage.getSessions(new Date(), new Date(), statChart);
}

function drawLastNDaysChart(n)
{
	//TO-DO: Make it aware of clock changes in summer/winter
	
	var endDate   = new Date();
	endDate.setHours(0);
	endDate.setMinutes(0);
	endDate.setSeconds(0);
	var startDate = new Date();
	
	startDate.setTime( endDate.getTime() - n*24*60*60*1000);
	
	surfSessionStorage.getSessions(startDate, endDate, statChart);
	
	document.getElementById("navText").innerText = "Last " + n + " days you navigated ";
}

showOpenedTabs();

</script>
<body>
<div id="mainDiv">
	<div id ="headerDiv">
		<span id="navText"></span>
		<span id="navTime"></span>
	</div>
	<div id="chartDiv">
		<div id="pieDiv"></div>
	</div>
	<div id="tableDiv"></div>
	<div id="bottomDiv">
		<a href="javascript:drawTodayChart()">Today</a>|<a href="javascript:drawLastNDaysChart(7)">Last seven days</a>|<a href="javascript:drawLastNDaysChart(30)">Last thirty days</a>
	</div>
</div>
</body>